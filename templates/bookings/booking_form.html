{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Agendamento{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
  .slot-btn { margin: .25rem .25rem 0 0; }
  .slot-btn.active { border-width: 2px; }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-3">Selecione um horário</h2>

<form method="post" novalidate>
  {% csrf_token %}
  {{ form.time_slot }} {# hidden #}

  {% if form.time_slot.errors %}
    <div class="alert alert-danger">{{ form.time_slot.errors }}</div>
  {% endif %}

  <div class="row g-3">
    <div class="col-md-5">
      <div class="card">
        <div class="card-body">
          <label class="form-label" for="provider-select">Prestador (opcional)</label>
          <select id="provider-select" class="form-select">
            <option value="">Todos</option>
            <!-- preencher dinamicamente via view ou hardcode -->
          </select>

          <label class="form-label mt-3" for="slot-date">Data</label>
          <input id="slot-date" name="slot_date" type="date" class="form-control">
          <div class="form-text">Escolha uma data para ver os horários disponíveis.</div>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Horários disponíveis</h5>
            <span id="slot-status" class="text-muted small"></span>
          </div>

          <div id="slot-times" class="mt-3"></div>

          <hr>
          <button id="submit-btn" type="submit" class="btn btn-primary" disabled>Agendar</button>
          <a class="btn btn-secondary" href="{% url 'booking_list' %}">Voltar</a>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
(function () {
  const dateInput = document.getElementById('slot-date');
  const container = document.getElementById('slot-times');
  const statusEl = document.getElementById('slot-status');
  const hiddenField = document.getElementById('id_time_slot');
  const submitBtn = document.getElementById('submit-btn');

  function setStatus(text) { statusEl.textContent = text || ''; }

  function clearSelection() {
    hiddenField.value = '';
    submitBtn.disabled = true;
    container.querySelectorAll('button[data-slot-id]').forEach(b => b.classList.remove('active'));
  }

  function renderSlots(slots) {
    container.innerHTML = '';
    clearSelection();

    if (!slots.length) {
      container.innerHTML = '<div class="text-muted">Nenhum horário disponível para esta data.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    slots.forEach(s => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary rounded-pill slot-btn';
      btn.textContent = `${s.start_time}`;
      btn.setAttribute('data-slot-id', s.id);

      // se tiver mais de um prestador, pode mostrar o nome:
      // btn.title = s.provider_name;

      btn.addEventListener('click', () => {
        container.querySelectorAll('button[data-slot-id]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        hiddenField.value = s.id;
        submitBtn.disabled = false;
      });

      frag.appendChild(btn);
    });
    container.appendChild(frag);
  }

  async function fetchSlots() {
    const d = dateInput.value;
    if (!d) {
      container.innerHTML = '<div class="text-muted">Selecione uma data.</div>';
      clearSelection();
      return;
    }

    setStatus('Carregando...');
    try {
      const url = "{% url 'availability_slots_api' %}" + `?date=${encodeURIComponent(d)}`;
      const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await resp.json();
      renderSlots(data.results || []);
      setStatus('');
    } catch (e) {
      container.innerHTML = '<div class="text-danger">Erro ao carregar horários.</div>';
      clearSelection();
      setStatus('');
    }
  }

  // default: hoje
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  dateInput.value = `${yyyy}-${mm}-${dd}`;

  dateInput.addEventListener('change', fetchSlots);
  fetchSlots();
})();
</script>
{% endblock %}